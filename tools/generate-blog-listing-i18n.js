#!/usr/bin/env node
// generate-blog-listing-i18n.js — Extract blog article translations and generate listing page i18n data
// Usage: node tools/generate-blog-listing-i18n.js
// Output: blog-listing-i18n.js (root directory)

const fs = require('fs');
const path = require('path');

const BLOG_DIR = path.join(__dirname, '..', 'blog');
const OUTPUT = path.join(__dirname, '..', 'blog-listing-i18n.js');

// Category translations (10 categories)
const CATEGORIES = {
  breed:     { en: 'Breeds',              zh: '品种知识' },
  health:    { en: 'Health',              zh: '健康管理' },
  nutrition: { en: 'Nutrition',           zh: '饮食营养' },
  grooming:  { en: 'Grooming',            zh: '日常护理' },
  behavior:  { en: 'Behavior & Training', zh: '行为训练' },
  kitten:    { en: 'Kitten Care',         zh: '幼猫养育' },
  breeder:   { en: 'Choosing a Breeder',  zh: '繁殖者选择' },
  allergy:   { en: 'Allergies',           zh: '过敏与低敏' },
  lifestyle: { en: 'Cat Life',            zh: '猫咪生活' },
  senior:    { en: 'Senior Cats',         zh: '老年猫护理' }
};

// Strip HTML tags and get plain text
function stripHtml(html) {
  if (!html) return '';
  return html
    .replace(/<[^>]+>/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&nbsp;/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

// Extract first ~100 characters as excerpt, trim to last complete sentence boundary
function makeExcerpt(html, maxLen) {
  maxLen = maxLen || 120;
  var text = stripHtml(html);
  if (text.length <= maxLen) return text;
  var cut = text.substring(0, maxLen);
  // Try to break at sentence boundary
  var lastPeriod = Math.max(cut.lastIndexOf('。'), cut.lastIndexOf('. '), cut.lastIndexOf('？'), cut.lastIndexOf('! '));
  if (lastPeriod > maxLen * 0.5) {
    return cut.substring(0, lastPeriod + 1) + '…';
  }
  // Break at word boundary
  var lastSpace = cut.lastIndexOf(' ');
  if (lastSpace > maxLen * 0.6) {
    return cut.substring(0, lastSpace) + '…';
  }
  return cut + '…';
}

// Escape single quotes for JS string literals
function escJS(str) {
  if (!str) return '';
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
}

// Extract _blogArticleI18n from an HTML file
function extractI18n(filePath) {
  var html = fs.readFileSync(filePath, 'utf8');

  // Find the window._blogArticleI18n block
  var startMarker = 'window._blogArticleI18n = {';
  var idx = html.indexOf(startMarker);
  if (idx === -1) return null;

  // Find the closing of the object — look for };\n</script> or similar
  var searchFrom = idx + startMarker.length;
  var depth = 1;
  var i = searchFrom;
  while (i < html.length && depth > 0) {
    if (html[i] === '{') depth++;
    if (html[i] === '}') depth--;
    i++;
  }

  var objStr = html.substring(idx + 'window._blogArticleI18n = '.length, i);

  // Evaluate safely using Function constructor
  try {
    var data = new Function('return ' + objStr)();
    return data;
  } catch (e) {
    console.error('  ⚠ Parse error in', path.basename(filePath), ':', e.message);
    return null;
  }
}

// Main
function main() {
  var files = fs.readdirSync(BLOG_DIR)
    .filter(f => f.endsWith('.html') && f !== 'index.html')
    .sort();

  console.log('Scanning', files.length, 'blog articles...');

  var articles = {};
  var missing = [];
  var count = 0;

  for (var f of files) {
    var slug = f.replace('.html', '');
    var filePath = path.join(BLOG_DIR, f);
    var data = extractI18n(filePath);

    if (!data || (!data.en && !data.zh)) {
      missing.push(slug);
      continue;
    }

    var entry = {};
    if (data.en) {
      entry.en = {
        title: data.en.title || '',
        excerpt: makeExcerpt(data.en.content, 120)
      };
    }
    if (data.zh) {
      entry.zh = {
        title: data.zh.title || '',
        excerpt: makeExcerpt(data.zh.content, 100)
      };
    }

    articles[slug] = entry;
    count++;
  }

  console.log('✅ Extracted:', count, 'articles');
  if (missing.length > 0) {
    console.log('⚠ Missing translations:', missing.length, '-', missing.join(', '));
  }

  // Build output JS
  var lines = [];
  lines.push('// blog-listing-i18n.js — Auto-generated by tools/generate-blog-listing-i18n.js');
  lines.push('// ' + count + ' articles with EN/ZH translations for blog.html listing page');
  lines.push('// Do NOT edit manually. Regenerate with: node tools/generate-blog-listing-i18n.js');
  lines.push('window._blogListingI18n = {');

  // Categories
  lines.push('  categories: {');
  for (var cat of Object.keys(CATEGORIES)) {
    lines.push("    '" + cat + "': { en: '" + escJS(CATEGORIES[cat].en) + "', zh: '" + escJS(CATEGORIES[cat].zh) + "' },");
  }
  lines.push('  },');

  // Hero text
  lines.push('  hero: {');
  lines.push("    en: { title: '\\ud83d\\udc31 Cat Knowledge Library', subtitle: 'From Siberian characteristics to cat health, kitten care and more. Expert knowledge from Fuluck Cattery, a specialized breeder in Osaka.' },");
  lines.push("    zh: { title: '\\ud83d\\udc31 猫咪知识库', subtitle: '从西伯利亚猫的特点到猫咪健康管理、幼猫养育等。大阪福楽猫舍（专业繁殖人）为您带来的猫咪知识集。' }");
  lines.push('  },');

  // Bottom CTA
  lines.push('  cta: {');
  lines.push("    en: { heading: 'Want to meet our kittens?', desc: 'Visit Fuluck Cattery in Osaka to see our kittens in person. We also offer LINE video calls.', kittensBtn: '\\ud83d\\udc3e View Kittens', lineBtn: '\\ud83d\\udcac Chat on LINE' },");
  lines.push("    zh: { heading: '想来看看我们的小猫吗？', desc: '欢迎来大阪福楽猫舍实地参观，也可以通过LINE视频通话。', kittensBtn: '\\ud83d\\udc3e 查看幼猫', lineBtn: '\\ud83d\\udcac LINE咨询' }");
  lines.push('  },');

  // Articles
  lines.push('  articles: {');
  for (var slug of Object.keys(articles).sort()) {
    var a = articles[slug];
    var parts = [];
    if (a.en) {
      parts.push("en:{title:'" + escJS(a.en.title) + "',excerpt:'" + escJS(a.en.excerpt) + "'}");
    }
    if (a.zh) {
      parts.push("zh:{title:'" + escJS(a.zh.title) + "',excerpt:'" + escJS(a.zh.excerpt) + "'}");
    }
    lines.push("    '" + slug + "': {" + parts.join(',') + "},");
  }
  lines.push('  }');
  lines.push('};');

  var output = lines.join('\n') + '\n';
  fs.writeFileSync(OUTPUT, output, 'utf8');

  var sizeKB = (Buffer.byteLength(output, 'utf8') / 1024).toFixed(1);
  console.log('✅ Written:', OUTPUT, '(' + sizeKB + ' KB)');
}

main();
